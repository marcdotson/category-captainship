---
title: "Generating Distributions of P-Values by Retailer"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages.
```{r}
#install.packages('tidyverse')
#install.packages("microsynth")
library(microsynth)
library(tidyverse)
```

Create simulated data by a random draw and add noise each period. Add a 25% increase in sales for the treated retailer in the post treatment period. Choose treatment period at week_end=80, halfway through simultaed time periods. 
```{r}
sales <- vector(mode = 'numeric', length = 160)

store_sales <- c()

for(i in 1:15) {
  
  sales <- vector(mode = 'numeric', length = 160)

  for(i in seq_along(sales)) {
  
    if(i == 1) {
    
      sales[i] <- runif(n = 1, min = 100, max = 1000)
    
    } else {
    
      sales[i] <- sales[i - 1] + rnorm(n = 1, mean = 10, sd = 5)
    
    }
    
  }
  
  store_sales <- c(store_sales, sales)
  
}

sim_data <- tibble(
  store_code_uc = sort(rep(1:15, times = 160)),
  retailer_code = ifelse(store_code_uc <= 5, 1, 
                  ifelse(store_code_uc <= 10, 2, 3)),
  n_week_end = rep(1:160, times = 15),
  sales = store_sales)

sim_data <- sim_data %>%
  rep_sample_n(size = nrow(.), reps = 3) %>%
  mutate(manuf = replicate) %>%
  ungroup() %>%
  select(retailer_code, store_code_uc, manuf, n_week_end, sales) %>%
  arrange(retailer_code, store_code_uc, manuf, n_week_end)

sim_data <- sim_data %>%
  mutate(sales = ifelse(retailer_code == 1 & n_week_end > 80, sales * 1.25, sales),
         treat = ifelse(retailer_code == 1, 1, 0),
         post = ifelse(n_week_end > 80, 1, 0))
```

Create a loop that creates a synthetic control for each store in each retailer. Collect the p values from each synthetic control and create a distribution of p values across stores by retailer. 
```{r}
ret_codes <- unique(sim_data$retailer_code)
msynth_results <- tibble()

for (i in seq_along(ret_codes)) {
  msynth_pvals <- c()
  msynth_effects <- c()
  t_stores <- sim_data %>% filter(retailer_code==ret_codes[i]) 
  c_stores <- sim_data %>% filter(retailer_code!=ret_codes[i]) %>% mutate(type=0) 
  t_store_codes <- unique(t_stores$store_code_uc)
  for (j in seq_along(t_store_codes)) {
    store <- t_stores %>% filter(store_code_uc==t_store_codes[j]) %>% 
      mutate(type = ifelse(n_week_end > 80, 1, 0))
    store_data <- bind_rows(store, c_stores)
    manufs <- unique(store_data$manuf)
    for (k in seq_along(manufs)) {
      manuf_data <- store_data %>%
        filter(manuf == manufs[i])
      msynth <- microsynth(data = manuf_data,
                           idvar = "store_code_uc",
                           intvar = "type",
                           timevar = "n_week_end",
                           start.pre = 1, 
                           end.pre = 80, 
                           end.post = 160,
                           match.out = "sales",
                           match.covar = "sales",
                           result.var="sales", 
                           omnibus.var="sales", 
                           plot.var="sales",
                           test="twosided", 
                           sep = TRUE,
                           use.survey = FALSE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`160`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`160`[1,3])
  
    }
  }
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    retailer = ret_codes[i]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results)

}
```

Plotting distributions of p-values and effects.
```{r}
msynth_results %>%
  ggplot(aes(x = pval)) +
  geom_histogram() +
  facet_wrap(~retailer)
```

```{r}
msynth_results %>%
  ggplot(aes(x = effect)) +
  geom_histogram() +
  facet_wrap(~retailer)
```









