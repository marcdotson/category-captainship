---
title: "North Dakota Initial Synthetic Control Regression Chart"
output: github_document
---

The treated retailer in North Dakota is 903. Captain is always 1, validator is always 2, private label is always 3, and aggregate others is always 4. If the exact implementation date is not available in the data, the next closest date following the implementation date is chosen. 

Load library and North Dakota data. 
```{r}
library(tidyverse)
library(lubridate)
library(microsynth)

load(here::here("..", "nd_cereal_clean.RData"))
nd_cereal <- nd_data

load(here::here("..", "nd_spreads_jams_clean.RData"))
nd_sj <- nd_data 

load(here::here("..", "nd_can_soup_clean.RData"))
nd_soup <- nd_data

load(here::here("..", "nd_ice_cream_clean.RData"))
nd_ice_cream <- nd_data

load(here::here("..", "nd_lunchmeat_clean.RData"))
nd_lmeat <- nd_data

load(here::here("..", "nd_novel_clean.RData"))
nd_novel <- nd_data

load(here::here("..", "nd_pb_clean.RData"))
nd_pb <- nd_data

load(here::here("..", "nd_pickles_olives_clean.RData"))
nd_pick <- nd_data

load(here::here("..", "nd_frozen_dinners_clean.RData"))
nd_frozen <- nd_data 

rm(nd_data)
```

Check manufacturers to see how many weeks they have. Manufacturers with less than 157 weeks of observations are dropped from the data.
```{r}
weeks <- unique(nd_pb$week_end)

codes <- unique(nd_pb$manuf_name)

drops <- c()

for (i in seq_along(codes)) {
  
  single_code <- nd_pb %>% filter(manuf_name==codes[i])
  
  single_code_vec <- unique(single_code$week_end)
  
  if (length(single_code_vec) < length(weeks)) {
    
    drops <- c(drops, codes[i])
    
  }

}

nd_pb <- nd_pb %>% 
  filter(!manuf_name %in% drops) %>% 
  arrange(retailer_code, store_code_uc, week_end) 
```

Aggregate captain, private label, validator and the "other" manufacturers, those that are not captain, validator, or private label. Impute missing data. First for peanut butter: 
```{r}
pb_cap <- nd_pb %>% filter(manuf_name=="SKI") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) %>% mutate(n_week_end=as.numeric(week_end))

pb_val <- nd_pb %>% filter(manuf_name %in% c("JIF", "SMU", "SIM", "SAN", "ADA")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) %>% mutate(n_week_end=as.numeric(week_end))

pb_ctl <- nd_pb %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) %>% mutate(n_week_end=as.numeric(week_end))

missing <- tibble(retailer_code=9, sales=1, manuf=4, n_week_end=15052)

#putting in sales as 1, so that log sales will be 0

pb_other <- nd_pb %>% filter(!manuf_name %in% c("JIF", "SMU", "SIM", "SAN", "ADA", "SKI", "CTL")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) %>%
  mutate(n_week_end=as.numeric(week_end))

pb_other <- pb_other %>% bind_rows(missing)  %>% arrange(by=n_week_end)

pb_agg <- pb_cap %>% bind_rows(pb_val) %>% bind_rows(pb_ctl) %>% bind_rows(pb_other)

rm(pb_cap, pb_val, pb_ctl, pb_other)
```

Clean data for microsynth. Create `treat` variable, convert `week_end` to a numeric, and create a log sales variable. Run a synthetic control comparing the captain in 903 as the treated group to the captains in the other two retailers as the control group. Run Microsynth loop for log sales for each manufacturer (1-4), store results in a table. Save msynth results as `pb_results`.
```{r, results="hide"}
pb_agg <- pb_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

pb_manufs <- unique(pb_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(pb_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- pb_agg %>% filter(manuf==pb_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15542, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = pb_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

pb_results <- msynth_results 
```

Aggregate sales, and check for missing data. If a manufacturer is missing data, impute sales as 1, so that log sales will be 0. For ice cream:
```{r}
ice_cap <- nd_ice_cream %>% filter(manuf_name %in% c("BEN", "TAL", "BRE", "UNI")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) %>% mutate(n_week_end=as.numeric(week_end))

ice_val <- nd_ice_cream %>% filter(manuf_name %in% c("DRE", "HAA")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) %>% mutate(n_week_end=as.numeric(week_end))

ice_ctl <- nd_ice_cream %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) %>% mutate(n_week_end=as.numeric(week_end))

ice_other <- nd_ice_cream %>% filter(!manuf_name %in% c("BEN", "TAL", "BRE", "UNI", "DRE", "HAA", "CTL")) %>%
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) %>%
  mutate(n_week_end=as.numeric(week_end))

anti_join(ice_cap, ice_val, by=c("week_end", "retailer_code"))

missing <- tibble(retailer_code=9, sales=1, manuf=2, n_week_end=15108)

ice_val <- ice_val %>% bind_rows(missing) %>% arrange(by=n_week_end)

ice_agg <- ice_cap %>% bind_rows(ice_val) %>% bind_rows(ice_ctl) %>% bind_rows(ice_other)

rm(ice_cap, ice_val, ice_ctl, ice_other)
```

Run the synthetic control for ice cream. Save the results as `ice_cream_results`. 
```{r, results="hide"}
ice_agg <- ice_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

ice_manufs <- unique(ice_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(ice_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- ice_agg %>% filter(manuf==ice_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15430, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = ice_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

ice_cream_results <- msynth_results
```

For cereal:
```{r}
cereal_cap <- nd_cereal %>% filter(manuf_name %in% c("G M", "ANN", "CAS")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) 

cereal_val <- nd_cereal %>% filter(manuf_name %in% c("KEL", "KAS", "BEA")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

cereal_ctl <- nd_cereal %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) 

cereal_other <- nd_cereal%>% filter(!manuf_name %in% c("G M", "ANN", "CAS", "KEL", "KAS", "BEA", "CTL")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

cereal_agg <- cereal_cap %>% bind_rows(cereal_val) %>% bind_rows(cereal_other) %>% bind_rows(cereal_ctl) %>% mutate(n_week_end=as.numeric(week_end))

rm(cereal_cap, cereal_val, cereal_ctl, cereal_other)
```

Run the synthetic control for ice cream. Save the results as `cereal_results`. 
```{r}
cereal_agg <- cereal_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

cereal_manufs <- unique(cereal_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(cereal_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- cereal_agg %>% filter(manuf==cereal_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15346, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = cereal_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

cereal_results <- msynth_results %>% arrange(manufacturer)
```

Impute missing data for the validator. For novelties: 
```{r}
n_cap <- nd_novel %>% filter(manuf_name %in% c("BEN", "POP", "GOO", "KLO", "BRE", "FUD", "CHO", "CRE", "MAG", "YOS", "FRU", "TAL")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) %>%
  mutate(n_week_end=as.numeric(week_end))

n_val <- nd_novel %>% filter(manuf_name %in% c("DRE", "EDY", "NES", "HAA", "SKI", "ESK", "CAR", "(IC", "THE")) %>% 
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) %>%
  mutate(n_week_end=as.numeric(week_end))

n_ctl <- nd_novel %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>%
  summarise(sales=sum(sales)) %>% mutate(manuf=3) %>% mutate(n_week_end=as.numeric(week_end))

n_other <- nd_novel %>% filter(!manuf_name %in% c("DRE", "EDY", "NES", "HAA", "SKI", "ESK", "CAR", "(IC", "THE", "BEN", "POP", "GOO", "KLO", "BRE", "FUD", "CHO", "CRE", "MAG", "YOS", "FRU", "TAL", "CTL")) %>%
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) %>%
  mutate(n_week_end=as.numeric(week_end))

anti_join(n_cap, n_val, by=c("week_end", "retailer_code"))

missing <- tibble(retailer_code=9, sales=1, manuf=2, n_week_end=15108)

n_val <- n_val %>% bind_rows(missing) %>% arrange(by=n_week_end)

novel_agg <- n_cap %>% bind_rows(n_val) %>% bind_rows(n_ctl) %>% bind_rows(n_other)

rm(n_cap, n_val, n_ctl, n_other)
```

Run the synthetic control for novelties. Save the results as `novel_results`. 
```{r}
novel_agg <- novel_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

novel_manufs <- unique(novel_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(novel_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- novel_agg %>% filter(manuf==novel_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15430, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = novel_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

novel_results <- msynth_results %>% arrange(manufacturer)
```

For pickles and olives: 
```{r}
pick_cap <- nd_pick %>% filter(manuf_name %in% c("VLA", "NAL") | brand_descr=="FARMER'S GARDEN") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) 

pick_val <- nd_pick %>% filter(manuf_name %in% c("EAR", "PEA", "GRE", "HOM", "BLA") | brand_descr=="MEDITERRANEAN PEARLS") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

pick_ctl <- nd_pick %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) 

pick_other <- nd_pick %>% filter(!manuf_name %in% c("VLA", "NAL", "EAR", "PEA", "GRE", "HOM", "BLA", "CTL")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

missing <- anti_join(pick_cap, pick_val, by=c("week_end", "retailer_code"))

missing <- missing %>% mutate(manuf=2) %>% mutate(sales=1)

pick_val <- pick_val %>% bind_rows(missing)

pick_agg <- pick_cap %>% bind_rows(pick_val) %>% bind_rows(pick_ctl) %>% bind_rows(pick_other) %>%
  mutate(n_week_end=as.numeric(week_end))

rm(pick_cap, pick_val, pick_ctl, pick_other)
```

Run the synthetic control for pickles and olives. Save the results as `pick_results`. 
```{r}
pick_agg <- pick_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

pick_manufs <- unique(pick_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(pick_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- pick_agg %>% filter(manuf==pick_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15556, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = pick_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

pick_results <- msynth_results %>% arrange(manufacturer)
```

For canned soup: 
```{r}
soup_cap <- nd_soup %>% filter(manuf_name =="CAM") %>% group_by(retailer_code, week_end) %>% 
  summarise(sales=sum(sales)) %>% mutate(manuf=1) 

soup_val <- nd_soup %>% filter(manuf_name=="PRO") %>% 
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

soup_ctl <- nd_soup %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) 

soup_other <- nd_soup %>% filter(!manuf_name %in% c("CAM", "CTL", "PRO")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

soup_agg <- soup_cap %>% bind_rows(soup_val) %>% bind_rows(soup_other) %>% bind_rows(soup_ctl) %>% mutate(n_week_end=as.numeric(week_end))

rm(soup_cap, soup_val, soup_ctl, soup_other)
```

Run the synthetic control for soup. Save the results as `soup_results`. 
```{r}
soup_agg <- soup_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

soup_manufs <- unique(soup_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(soup_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- soup_agg %>% filter(manuf==soup_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15556, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = soup_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

soup_results <- msynth_results %>% arrange(manufacturer)
```

For spreads & jams: 
```{r}
sj_cap <- nd_sj %>% filter(manuf_name %in% c("SMU","SAN","R W", "DIC", "KIN", "CRO")) %>% group_by(retailer_code, week_end) %>% 
  summarise(sales=sum(sales)) %>% mutate(manuf=1) 

sj_val <- nd_sj %>% filter(manuf_name=="WEL") %>% 
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

sj_ctl <- nd_sj %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) 

sj_other <- nd_sj %>% filter(!manuf_name %in% c("WEL", "CTL", "SMU","SAN","R W", "DIC", "KIN", "CRO")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

sj_agg <- sj_cap %>% bind_rows(sj_val) %>% bind_rows(sj_ctl) %>% bind_rows(sj_other) %>% mutate(n_week_end=as.numeric(week_end))

rm(sj_cap, sj_val, sj_ctl, sj_other)
```

Run the synthetic control for spreads and jams. Save the results as `sj_results`. 
```{r}
sj_agg <- sj_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

sj_manufs <- unique(sj_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(sj_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- sj_agg %>% filter(manuf==sj_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15542, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = sj_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

sj_results <- msynth_results %>% arrange(manufacturer)
```

For lunchmeat:
```{r}
lmeat_cap <- nd_lmeat %>% filter(manuf_name=="OSC") %>% group_by(retailer_code, week_end) %>% 
  summarise(sales=sum(sales)) %>% mutate(manuf=1) 

lmeat_val <- nd_lmeat %>% filter(manuf_name=="SAR" | brand_descr %in% c("HILLSHIRE FARM", "HILLSHIRE FARM GOURMET CREATIN", 
                                                                     "HILLSHIRE FARM DELI SELECT", "HILLSHIRE FARM DELI CARVERS", 
                                                                     "HILLSHIRE FARM LIT'L WIENERS", "HILLSHIRE FARM LIT'L SMOKIES",
                                                                     "HILLSHIRE FARM LIT'L POLSKAS", "HILLSHIRE FARM LIT'L BEEF FRNK",
                                                                     "HILLSHIRE FARM YARD-O-BEEF")) %>% 
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

lmeat_ctl <- nd_lmeat %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>%
  mutate(manuf=3) 

lmeat_other <- nd_lmeat %>% filter(!manuf_name %in% c("OSC", "SAR", "CTL") | !brand_descr %in% c("HILLSHIRE FARM", "HILLSHIRE FARM GOURMET CREATIN",  "HILLSHIRE FARM DELI SELECT", "HILLSHIRE FARM DELI CARVERS", "HILLSHIRE FARM LIT'L WIENERS", "HILLSHIRE FARM LIT'L SMOKIES", "HILLSHIRE FARM LIT'L POLSKAS", "HILLSHIRE FARM LIT'L BEEF FRNK", "HILLSHIRE FARM YARD-O-BEEF")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

lmeat_agg <- lmeat_cap %>% bind_rows(lmeat_val) %>% bind_rows(lmeat_other) %>% bind_rows(lmeat_ctl) %>% mutate(n_week_end=as.numeric(week_end))

rm(lmeat_cap, lmeat_val, lmeat_ctl, lmeat_other)
```

Run the synthetic control for lunchmeat. Save the results as `lmeat_results`. 
```{r}
lmeat_agg <- lmeat_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

lmeat_manufs <- unique(lmeat_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(lmeat_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- lmeat_agg %>% filter(manuf==lmeat_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15542, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = lmeat_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

lmeat_results <- msynth_results %>% arrange(manufacturer)
```

For frozen dinners: 
```{r}
frozen_cap <- nd_frozen %>% filter(manuf_name %in% c("STO", "LEA", "BUI", "SWE")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=1) 

frozen_val <- nd_frozen %>% filter(manuf_name %in% c("BAN", "MAR", "BER", "HEA", "KID", "P.F", "BLA")) %>% 
  group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=2) 

frozen_ctl <- nd_frozen %>% filter(manuf_name=="CTL") %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=3) 

frozen_other <- nd_frozen %>% filter(!manuf_name %in% c("STO", "LEA", "BUI", "SWE", "BAN", "MAR", "BER", "HEA", "KID", "P.F", "BLA", "CTL")) %>% group_by(retailer_code, week_end) %>% summarise(sales=sum(sales)) %>% mutate(manuf=4) 

frozen_agg <- frozen_cap %>% bind_rows(frozen_val) %>% bind_rows(frozen_ctl) %>% bind_rows(frozen_other) %>%
  mutate(n_week_end=as.numeric(week_end))

rm(frozen_cap, frozen_val, frozen_ctl, frozen_other)
```

Run the synthetic control for frozen dinners. Save the results as `frozen_dinners_results`. 
```{r}
frozen_agg <- frozen_agg %>% mutate(treat=if_else(retailer_code==903, 1, 0)) %>% mutate(lsales=log(sales)) 

frozen_manufs <- unique(frozen_agg$manuf)

msynth_results <- tibble()
loop_results <- tibble()

  for (j in seq_along(frozen_manufs)) {
    msynth_pvals <- c()
    msynth_effects <- c()
    manuf_data <- frozen_agg %>% filter(manuf==frozen_manufs[j])
    msynth <- microsynth(data = as.data.frame(manuf_data),
                           idvar = "retailer_code",
                           intvar = "treat",
                           timevar = "n_week_end",
                           start.pre = 14975, 
                           end.pre = 15416, 
                           end.post = 16067,
                           match.out = "lsales",
                           match.out.min = "lsales",
                           result.var="lsales", 
                           omnibus.var="lsales", 
                           test="twosided", 
                           use.survey = FALSE,
                           use.backup=TRUE)
  
  msynth_pvals <- c(msynth_pvals, msynth[[2]]$`16067`[1,4])
  msynth_effects <- c(msynth_effects, msynth[[2]]$`16067`[1,3])
  
  loop_results <- tibble(
    pval = msynth_pvals,
    effect = msynth_effects,
    manufacturer = frozen_manufs[j]
  )
  
  msynth_results <- msynth_results %>%
    bind_rows(loop_results) }

frozen_dinners_results <- msynth_results %>% arrange(manufacturer)
```

Merge results for each category into one regression table for North Dakota. 
```{r}
Categories <- c("Cereal", "Frozen Dinners", "Ice Cream", "Lunchmeat", "Novelties", "Peanut Butter", "Pickles/Olives", "Spreads/Jams", "Canned Soup")

Manufacturers <- c("Categories", "Captain", "Validator", "Private Label", "Other")

c <- cereal_results %>% mutate(category="Cereal") %>% select(-pval)

fd <- frozen_dinners_results %>% mutate(category="Frozen Dinners") %>% select(-pval)

ic <- ice_cream_results %>% mutate(category="Ice Cream") %>% select(-pval)

lm <- lmeat_results %>% mutate(category="Lunchmeat") %>% select(-pval)

n <- novel_results %>% mutate(category="Novelties") %>% select(-pval)

pb <- pb_results %>% mutate(category="Peanut Butter") %>% select(-pval)

po <- pick_results %>% mutate(category="Pickles and Olives") %>% select(-pval)

sj <- sj_results %>% mutate(category="Spreads and Jams") %>% select(-pval)

sp <- soup_results %>% mutate(category="Canned Soup") %>% select(-pval)

reg_table <- fd %>% bind_rows(c) %>% bind_rows(ic) %>% bind_rows(lm) %>% bind_rows(n) %>% bind_rows(pb) %>% bind_rows(po) %>% bind_rows(sj) %>% bind_rows(sp) %>% mutate(effect=round(effect, digits=3))

reg_table <- reg_table %>% spread(key=manufacturer, value=effect) 

names(reg_table) <- c("Category", "Captain", "Validator", "Private Label", "Aggregate Other")

write.csv(reg_table, file="ND Synthetic Control Results.csv")
```


