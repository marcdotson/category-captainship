---
title: "RDiT with Market Share as Proportion of Total Assortment"
output: github_document
---

Load packages.
```{r}
library(tidyverse)
```

Load data.
```{r}
load(here::here("..", "mn_cereal_clean.RData"))
```

Create a loop that plots market share for the category captain for each retailer.
Create `captain_prods` by filtering for a single retailer and for the brands owned by the 
captain, in this category (cereal) the captain is general mills, and then summarizing the
number of unique products sold by the captain in each store in each week. 
Create `total_prods` which is similar to `captain_prods` except it contains the total number of
unique products sold in a store in a given week. Create `mkt_share` by joining `captain_prods` 
and `total_prods`, then create the variable `capt_market_share` by dividing the number of unique
products sold by the captain by the number sold in the store in a given week. Plot the market 
share for the captain on a weekly basis for each store. Include a vertical red line at the 
captainship implementation date.
```{r fig.width=9, fig.height=7}
ret_codes <- unique(mn_data$retailer_code)

for (i in seq_along(ret_codes)) {
  
  captain_prods <- mn_data %>%
    filter(retailer_code == ret_codes[i] & manuf_name %in% c("G M", "ANN", "CAS")) %>%
    group_by(store_code_uc, week_end) %>%
    summarize(n_captain_prods = n())
  
  total_prods <- mn_data %>%
    filter(retailer_code == ret_codes[i]) %>%
    group_by(store_code_uc, week_end) %>%
    summarize(total_prods = n())
  
  mkt_share <- captain_prods %>%
    left_join(total_prods, by = c('store_code_uc', 'week_end')) %>%
    mutate(capt_market_share = n_captain_prods / total_prods)
  
  mkt_share_plot <- mkt_share %>%
    ggplot(aes(x = week_end, 
               y = capt_market_share)) +
    geom_point() +
    geom_vline(xintercept = as.numeric(as.Date("2012-01-07")), 
               color = 'red') +
    facet_wrap(~store_code_uc) +
    labs(x = 'Week',
         y = 'Market Share',
         title = paste('Weekly Market Share for Captain by Store for Retailer', ret_codes[i]),
         subtitle = "Cereal Category")
  
  print(mkt_share_plot)
  
}
```

Create a heat map chart that shows all UPCs in store 2314183 in retailer 221, with unit sales in each cell. Filter for the store we want. 
```{r}
store_2314183 <- mn_data %>% filter(store_code_uc== 2314183) %>% distinct(upc, week_end, units) %>% arrange(week_end)
```

Fill in zeros for upc with missing sales in a given week. Create the chart. 
```{r}
 chart_data <- matrix(nrow = n_distinct(store_2314183$upc), 
                      ncol = n_distinct(store_2314183$week_end))
    
    colnames(chart_data) <- as.character(unique(store_2314183$week_end))
    
    rownames(chart_data) <- unique(store_2314183$upc)
    
    ind_upcs <- unique(store_2314183$upc)
    
    for (k in seq_along(ind_upcs)) {
      
      single_upc_sales <- store_2314183 %>%
        select(upc, week_end, units) %>%
        filter(upc == ind_upcs[k])
      
      no_sales <- store_2314183 %>%
        distinct(week_end) %>%
        anti_join(single_upc_sales, by = "week_end") %>%
        mutate(upc = ind_upcs[k], units = 0)
      
      single_upc_sales <- single_upc_sales %>%
        bind_rows(no_sales) %>%
        arrange(week_end) 
      
      chart_data[ind_upcs[k],] <- single_upc_sales$units
      
    }
    
    brks <- quantile(chart_data, probs = seq(.05, .95, .05), na.rm = TRUE)
    
    clrs <- round(seq(255, 40, length.out = length(brks) + 1), 0) %>% 
    {paste0("rgb(255,", ., ",", ., ")")}
    
    chart_data <- as_tibble(chart_data, rownames = NA)
    
    sales_table <- datatable(chart_data, caption = "UPCs in Store 2314183") %>% 
      formatStyle(names(chart_data), backgroundColor = styleInterval(brks, clrs))
    
    print(sales_table)
    
    
```

Try another way. 
```{r}
chart <- tibble()

ind_upcs <- unique(store_2314183$upc)
    
    for (k in seq_along(ind_upcs)) {
      
      single_upc_sales <- store_2314183 %>%
        select(upc, week_end, units) %>%
        filter(upc == ind_upcs[k])
      
      no_sales <- store_2314183 %>%
        distinct(week_end) %>%
        anti_join(single_upc_sales, by = "week_end") %>%
        mutate(upc = ind_upcs[k], units = 0)
      
      chart <- chart %>%
        bind_rows(no_sales) %>% bind_rows(single_upc_sales) %>%
        arrange(week_end) 
      
    }

chart <- chart %>% spread(key=week_end, value=units)

library(formattable)

customGreen0 <- "#DeF7E9"
customGreen <- "#71CA97"

formattable(chart, lapply(1:nrow(chart), function(row) {area(row, col= -1) ~ color_tile(customGreen0, customGreen) } ) ) 
```






















