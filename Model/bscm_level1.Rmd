---
title: "Bayesian Synthetic Control Level 1"
author: "Morgan Bale"
date: "10/4/2021"
output: github_document
---

The purpose of this file to use synthetic data to test the bayesian synthetic control model with data at the store, brand, and time level. The model comes from the web index of the Gupta paper, part B.1 BSCM-Horseshoe. This file begins to customize the model to our paper, e.g. changing index and variable names. 

```{r, include=FALSE}
library(tidyverse)
library(rstan)
library(bayesplot)
library(gtools)
library(rstan)

rstan_options(auto_write=TRUE) # writes a compiled Stan program to the disk to avoid recompiling
options(mc.cores = parallel::detectCores()-1) # uses multiple cores for stan
```

##### DATA #######

Function for making synthetic data: incorporate brand and store level data across multiple time periods. Assume brands are nested within stores? 
```{r}
gen_b1_data <- function(N_train=40,     #num of obs in pre treatment
                        N_test=20,      #num of obs in post treatment 
                        S=4,            #num of control stores
                        B=3,            #num of brands within each store
                        beta_0=1.5,     #intercept
                        sigma2=0.05,    #error term variance 
                        tau=0.01        #global shrinkage 
                        ) {

  #C=S*B         #num store brand combinations 
  #b <- rep(1:B, times=S)    #brand for each X column
  #s <- rep(1:S, each=B)     #store for each X column 
  #X_train <- matrix(rnorm(N_train*C), nrow=N_train, ncol=C)          #control unit matrix in pre treatment
  X_train <- array(rnorm(N_train*S*B), dim=c(B, N_train, S))         #control unit matrix pre treatment 
  #X_test <- matrix(rnorm(N_test*C), nrow=N_test, ncol=C)            #control unit matrix in post treatment 
  X_test <- array(rnorm(N_test*S*B), dim=c(B, N_test, S))         #control unit matrix post treatment 
  #lambda_unif <- runif(C, min=0, max=pi/2)         #hyper parameter prior 
  lambda_unif <- matrix(runif(S*B, min=0, max=pi/2), nrow=S, ncol=B)
  lambda <- tau * tan(lambda_unif)                     #local shrinkage 
  
  #beta_raw <- rep(1/C, C)                             #control unit weights before transformation 
  #beta <- rnorm(C)                                    #control unit weights
  #for(c in 1:C) {
    #beta[c] = lambda[c] * beta_raw[c]
  #}
  
  beta_raw <- matrix(1/S, nrow=S, ncol=B)
  beta <- matrix(NA, nrow=S, ncol=B)
  for(s in 1:S) {
    for(b in 1:B) {
      beta[s, b] <- lambda[s,b] * beta_raw[s,b]
    }
  }
  
  #model 
  sigma=sqrt(sigma2)
  #X_beta <- beta_0 + X_train*beta 
  
  X_beta <- array(NA, dim=c(N_train, B))
  
  for(b in 1:B) {
    X_beta[,b] <- beta_0 + X_train[b,,] %*% beta[,b]
  }
  
  y_train = matrix(rnorm(N_train, mean=X_beta, sd=sigma), nrow=N_train, ncol=B) 
  
  y_train <- matrix(NA, nrow=N_train, ncol=B)
  for(b in 1:B) {
    y_train[,b] <- rnorm(N_train, mean=X_beta[,b], sd=sigma)
  }
  
  #make a list for stan
  list(N_train=N_train, N_test=N_test, S=S, B=B, C=C, beta_0=beta_0, sigma2=sigma2, tau=tau, X_train=X_train, X_test=X_test, lambda=lambda, lambda_unif=lambda_unif,
       beta_raw=beta_raw, beta=beta, sigma=sigma, X_beta=X_beta, y_train=y_train, b=b, s=s)
}
```

Create synthetic data
```{r}
set.seed(2020)
b1_data <- gen_b1_data(tau=3)
#str(b1_data)
```

###### MODEL ########

Run model using `bcsm_b1.stan`
```{r}
b1_model <- stan_model(file="bscm_level1.stan")
#print(b1_model)
```

```{r}
draws <- sampling(b1_model, data=b1_data, seed=2020, cores=3)
```

###### RESULTS ######

Check results
```{r}
#traceplots
traceplot(draws, pars="tau")
traceplot(draws, pars="beta")
traceplot(draws, pars="sigma")
traceplot(draws, pars="lambda")
```

```{r}
mcmc_recover_hist(As.mcmc.list(draws, pars="beta"), true=as.vector(t(b1_data$beta)))
mcmc_recover_hist(As.mcmc.list(draws, pars="lambda"), true=as.vector(t(b1_data$lambda)))
mcmc_recover_hist(As.mcmc.list(draws, pars="sigma"), true=as.vector(t(b1_data$sigma)))
```

Fitted Synthetic Control for pre treatment
```{r}
#synthetic control for pre treatment
y_fit <- summary(draws, pars="y_fit")

sc_pre <- tibble(y_fit[[1]][,1])

lower <- y_fit[[1]][,4]
upper <- y_fit[[1]][,8]

sc_pre <- sc_pre %>% bind_cols(lower, upper)

sc_pre <- sc_pre %>% mutate(week=rep(1:b1_data$N_train))

names(sc_pre) <- c("synthetic_control","lower", "upper", "week")
```

Treated unit in the pre treatment
```{r}
y_train <- b1_data$y_train

sc_data <- sc_pre %>% bind_cols(y_train)

names(sc_data)[5] <- "treatment_group"

sc_data %>% ggplot(aes(x=week))+ geom_ribbon(aes(ymin=lower, ymax=upper), fill="gray80") + geom_line(aes(y=treatment_group), color="darkred") + geom_line(aes(y=synthetic_control), color="steelblue") + 
  labs(x="Week", y="Pre Treatment Value") + ggtitle("Pre Treatment Synthetic Control (blue) vs Treatment Group (red)") 
```

Predicted Synthetic Control for post treatment
```{r}
y_test <- summary(draws, pars="y_test")

sc_post <- tibble(y_test[[1]][,1])

lower <- y_test[[1]][,4]
upper <- y_test[[1]][,8]

sc_post <- sc_post %>% bind_cols(lower, upper)

sc_post <- sc_post %>% mutate(week=rep((b1_data$N_train+1):(b1_data$N_train+b1_data$N_test)))

names(sc_post) <- c("synthetic_control", "lower", "upper", "week")
```

Make treatment data for post period
```{r}
y_post <- y_train + .8
y_post <- y_post[1:b1_data$N_test]

y_post <- as_tibble(y_post) %>% mutate(week=rep((b1_data$N_train+1):(b1_data$N_train+b1_data$N_test)))

sc_post <- sc_post %>% left_join(y_post, by="week")

names(sc_post)[5] <- "treatment_group"

total_sc_data <- sc_data %>% bind_rows(sc_post)

total_sc_data %>% ggplot(aes(x=week)) + geom_ribbon(aes(ymin=lower, ymax=upper), fill="gray80") + geom_line(aes(y=treatment_group), color="darkred") + geom_line(aes(y=synthetic_control), color="steelblue") +
  labs(x="Week", y="Value") + ggtitle("Synthetic Control (blue) vs Treatment Group (red)") + geom_vline(xintercept=b1_data$N_train) 
```


















