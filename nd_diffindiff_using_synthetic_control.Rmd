---
title: "North Dakota Diff in diff model using synthetic control from Microsynth"
output: github_document
---

Load libraries and data for each category in ND. 
```{r}
library(tidyverse)
library(microsynth)

load(here::here("..", "nd_cereal_clean.RData"))
nd_cereal <- nd_data

load(here::here("..", "nd_spreads_jams_clean.RData"))
nd_sj <- nd_data 

load(here::here("..", "nd_can_soup_clean.RData"))
nd_soup <- nd_data

load(here::here("..", "nd_ice_cream_clean.RData"))
nd_ice_cream <- nd_data

load(here::here("..", "nd_lunchmeat_clean.RData"))
nd_lmeat <- nd_data

load(here::here("..", "nd_novel_clean.RData"))
nd_novel <- nd_data

load(here::here("..", "nd_pb_clean.RData"))
nd_pb <- nd_data

load(here::here("..", "nd_pickles_olives_clean.RData"))
nd_pick <- nd_data

load(here::here("..", "nd_frozen_dinners_clean.RData"))
nd_frozen <- nd_data 

rm(nd_data)
```

Create a smaller data set with only the variables we are interested in. Create `upc_weeks` which reports the number of weeks each upc has sales for in store code X and filters for upcs that have less than 157 weeks. Check that the maximum number of weeks is not greater than 157. 
```{r}
cereal_slim <- nd_cereal %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31") %>% mutate(n_date=as.numeric(week_end))

full_weeks <- cereal_slim %>% distinct(week_end)

partial_upc <- cereal_slim %>% filter(store_code_uc==187110) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()

single_upc <- cereal_slim %>% filter(store_code_uc==187110, upc=="001600014772")

full_weeks %>% anti_join(single_upc, by="week_end")


```




Check each category for weeks with missing sales. 
```{r}
nd_cereal <- nd_cereal %>% filter(week_end>"2010-12-31")

nd_cereal_slim <- nd_cereal %>% select(upc, sales, week_end, manuf_name, store_code_uc)

cereal_weeks <- nd_cereal %>% distinct(store_code_uc, upc, week_end) %>% group_by(store_code_uc, upc) %>% summarise(n_weeks=n())

missing_weeks <- cereal_weeks %>% filter(n_weeks<157)

full_dates <- nd_cereal %>% filter(upc=="001600027503") %>% select(week_end) %>% distinct(week_end) 

store <- unique(missing_weeks$store_code_uc)
```

Turn into a loop
```{r}
for(i in seq_along(store)) {

  single_store <- nd_cereal_slim %>% filter(store_code_uc==store[i])
  
  upcode <- unique(single_store$upc)
  
for(k in seq_along(upcode)) {
  
 missing_upc <- single_store %>% filter(upc==upcode[k])
 
 missing <- anti_join(full_dates, missing_upc, by="week_end") %>% mutate(sales=0, upc=upcode[k], manuf_name=unique(missing_upc$manuf_name))
 
 nd_cereal_slim <- nd_cereal_slim %>% bind_rows(missing)
 
}}
```






