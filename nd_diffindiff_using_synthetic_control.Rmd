---
title: "North Dakota Diff in diff model using synthetic control from Microsynth"
output: github_document
---

Load libraries and data for each category in ND. 
```{r}
library(tidyverse)
library(microsynth)

load(here::here("..", "nd_cereal_clean.RData"))
nd_cereal <- nd_data

load(here::here("..", "nd_spreads_jams_clean.RData"))
nd_sj <- nd_data 

load(here::here("..", "nd_can_soup_clean.RData"))
nd_soup <- nd_data

load(here::here("..", "nd_ice_cream_clean.RData"))
nd_ice_cream <- nd_data

load(here::here("..", "nd_lunchmeat_clean.RData"))
nd_lmeat <- nd_data

load(here::here("..", "nd_novel_clean.RData"))
nd_novel <- nd_data

load(here::here("..", "nd_pb_clean.RData"))
nd_pb <- nd_data

load(here::here("..", "nd_pickles_olives_clean.RData"))
nd_pick <- nd_data

load(here::here("..", "nd_frozen_dinners_clean.RData"))
nd_frozen <- nd_data 

rm(nd_data)
```

Create a smaller data set with only the variables we are interested in, and filter for observations only after 2010. 
```{r}
cereal_slim <- nd_cereal %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")
```

Create a `stores` vector that contains the unique store codes in the `cereal_slim` dataset. Create `full_weeks` which is a list of the 157 `week_end`s from 2011-2013. Write a loop that goes along each store and upc adding in zero sales values for upcs with missing dates (less than 157 weeks). Bind those missing upc dates and sales back into the main data `cereal_slim`. 
```{r}
stores <- unique(cereal_slim$store_code_uc)

full_weeks <- cereal_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- cereal_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- cereal_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    cereal_slim <- cereal_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_cereal)
```

Replicate for the other categories: 

Spreads & Jams
```{r}
sj_slim <- nd_sj %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(sj_slim$store_code_uc)

full_weeks <- sj_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- sj_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- sj_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    sj_slim <- sj_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_sj)
```

Canned soup
```{r}
soup_slim <- nd_soup %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(soup_slim$store_code_uc)

full_weeks <- soup_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- soup_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- soup_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    soup_slim <- soup_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_soup)
```

Ice Cream #upcs that switch manufacturers, need to fix the error
```{r}
icecream_slim <- nd_ice_cream %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(icecream_slim$store_code_uc)

full_weeks <- icecream_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- icecream_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- icecream_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    icecream_slim <- icecream_slim %>% bind_rows(missing_weeks)
    
  }
}

#rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_ice_cream)
```

Count finds the number of manufacturers per UPC. The upcs with two manufacturers create an error. There are two upcs with the problem and they are stores in `problem_child` and `problem_child_full` (full contains all the variables). One of the two upcs has the manufacturer change (ITT to KEM) from 2011 to 2012 and it occurs in multiple stores. The other upc has the manufacturer change (Starbucks to UNI) from 2011 to 2012, but occurs in only one store. We want to see how large these upc's sales are relative to the other upcs in their respective stores. If their sales are relatively small, we will drop them, if they are large... `agg` aggregates the sales for upcs within stores across the three years and ranks them by sales. 
```{r}
count <- nd_ice_cream %>% distinct(upc, manuf_name) %>% group_by(upc) %>% summarise(n_manuf=n())
count %>% filter(n_manuf>1)

problem_child <- icecream_slim %>% filter(upc %in% c("004148303571", "007756708215"))

problem_child <- problem_child %>% arrange(store_code_uc, upc)

prob_child_full <- nd_ice_cream %>% filter(upc %in% c("004148303571", "007756708215")) %>% arrange(store_code_uc, upc)

#see how problem child's sales compare to the rest of the upcs

agg <- icecream_slim %>% group_by(store_code_uc, upc) %>% summarise(sum_sales=sum(sales)) %>% arrange(store_code_uc, desc(sum_sales))

agg %>% filter(store_code_uc==790659, upc %in% c("004148303571", "007756708215"))
```

















