---
title: "North Dakota Diff in diff model using synthetic control from Microsynth"
output: github_document
---

Load libraries and data for each category in ND. 
```{r}
library(tidyverse)
library(microsynth)

load(here::here("..", "nd_cereal_clean.RData"))
nd_cereal <- nd_data

load(here::here("..", "nd_spreads_jams_clean.RData"))
nd_sj <- nd_data 

load(here::here("..", "nd_can_soup_clean.RData"))
nd_soup <- nd_data

load(here::here("..", "nd_ice_cream_clean.RData"))
nd_ice_cream <- nd_data

load(here::here("..", "nd_lunchmeat_clean.RData"))
nd_lmeat <- nd_data

load(here::here("..", "nd_novel_clean.RData"))
nd_novel <- nd_data

load(here::here("..", "nd_pb_clean.RData"))
nd_pb <- nd_data

load(here::here("..", "nd_pickles_olives_clean.RData"))
nd_pick <- nd_data

load(here::here("..", "nd_frozen_dinners_clean.RData"))
nd_frozen <- nd_data 

rm(nd_data)
```

Get retail code to merge with slim data for creating `treat` variable.
```{r}
r_cereal <- nd_cereal %>% distinct(store_code_uc, retailer_code)

r_sj <- nd_sj %>% distinct(store_code_uc, retailer_code)

r_soup <- nd_soup %>% distinct(store_code_uc, retailer_code)

r_icecream <- nd_ice_cream %>% distinct(store_code_uc, retailer_code)

r_lmeat <- nd_lmeat %>% distinct(store_code_uc, retailer_code)

r_novel <- nd_novel %>% distinct(store_code_uc, retailer_code)

r_pb <- nd_pb %>% distinct(store_code_uc, retailer_code)

r_pickles <- nd_pick %>% distinct(store_code_uc, retailer_code)

r_frozen <- nd_frozen %>% distinct(store_code_uc, retailer_code)
```

Create a smaller data set with only the variables we are interested in, and filter for observations only after 2010. 
```{r}
cereal_slim <- nd_cereal %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")
```

Create a `stores` vector that contains the unique store codes in the `cereal_slim` dataset. Create `full_weeks` which is a list of the 157 `week_end`s from 2011-2013. Write a loop that goes along each store and upc adding in zero sales values for upcs with missing dates (less than 157 weeks). Bind those missing upc dates and sales back into the main data `cereal_slim`. 
```{r}
stores <- unique(cereal_slim$store_code_uc)

full_weeks <- cereal_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- cereal_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- cereal_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    cereal_slim <- cereal_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_cereal)
```

Replicate for the other categories: 

Spreads & Jams
```{r}
sj_slim <- nd_sj %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(sj_slim$store_code_uc)

full_weeks <- sj_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- sj_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- sj_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    sj_slim <- sj_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_sj)
```

Canned soup
```{r}
soup_slim <- nd_soup %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(soup_slim$store_code_uc)

full_weeks <- soup_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- soup_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- soup_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    soup_slim <- soup_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_soup)
```

Ice Cream

Delete observations where the upc has two different manufacturer (see code below for why)
```{r}
icecream_slim <- nd_ice_cream %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

drops_1 <- icecream_slim %>% filter(upc=="004148303571" & store_code_uc %in% c(790659, 791868, 7326857, 7329996, 8135076))

drops_2 <- icecream_slim %>% filter(upc=="007756708215" & store_code_uc==4471593)

drops <- drops_1 %>% bind_rows(drops_2)

chr <- c("store_code_uc", "upc")

icecream_slim <- anti_join(x=icecream_slim, y=drops, by=chr)

rm(drops, drops_1, drops_2)
```

Same loop as above
```{r}
stores <- unique(icecream_slim$store_code_uc)

full_weeks <- icecream_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- icecream_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- icecream_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    icecream_slim <- icecream_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_ice_cream)
```

Count finds the number of manufacturers per UPC. The upcs with two manufacturers create an error. There are two upcs with the problem and they are stored in `problem_child`. One of the two upcs has the manufacturer change (ITT to KEM) from 2011 to 2012 and it occurs in multiple stores. The other upc has the manufacturer change (Starbucks to UNI) from 2011 to 2012, but occurs in only one store. 
```{r, eval=FALSE}
count <- nd_ice_cream %>% distinct(upc, manuf_name) %>% group_by(upc) %>% summarise(n_manuf=n())

count %>% filter(n_manuf>1) #upcs with more than 1 manufacturer

problem_child <- icecream_slim %>% filter(upc %in% c("004148303571", "007756708215"))

problem_child <- problem_child %>% arrange(store_code_uc, upc)
```

We want to see how large these upc's sales are relative to the other upcs in their respective stores. If their sales are relatively small, we will drop them, if they are large...? `agg` aggregates the sales for upcs within stores across the three years and ranks them by sales. The for loop creates `upc_rankings` which shows how the sales for the problem upcs compare to their store total. 
```{r, eval=FALSE}
agg <- icecream_slim %>% group_by(store_code_uc, upc) %>% summarise(sum_sales=sum(sales)) %>% arrange(store_code_uc, desc(sum_sales))

upc_rankings <- data.frame()

problem_stores <- unique(problem_child$store_code_uc)

for(i in seq_along(problem_stores)) {
  agg_store <- agg %>% filter(store_code_uc==problem_stores[i]) %>% mutate(rank=dense_rank(desc(sum_sales)))
  total_rank <- max(agg_store$rank)
  agg_upc <- agg_store %>% filter(upc %in% c("004148303571", "007756708215")) 
  agg_upc$total=total_rank
  upc_rankings <- upc_rankings %>% bind_rows(agg_upc)
}

rm(agg_store, total_rank, agg_upc, problem_child, agg, count)
```

Lunchmeat

Delete observations where the upc has two different manufacturer (see code below for why)
```{r}
lmeat_slim <- nd_lmeat %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

lmeat_slim <- lmeat_slim %>% filter(upc!="007010001590")
```

Same loop as above
```{r}
stores <- unique(lmeat_slim$store_code_uc)

full_weeks <- lmeat_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- lmeat_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- lmeat_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    lmeat_slim <- lmeat_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_lmeat)
```

See description above (fixing mutliple manufacturer for 1 upc problem)
```{r, eval=FALSE}
count <- nd_lmeat%>% distinct(upc, manuf_name) %>% group_by(upc) %>% summarise(n_manuf=n())

count %>% filter(n_manuf>1) #upcs with more than 1 manufacturer

problem_child <- lmeat_slim %>% filter(upc=="007010001590")

problem_child <- problem_child %>% arrange(store_code_uc, upc)

agg <- lmeat_slim %>% group_by(store_code_uc, upc) %>% summarise(sum_sales=sum(sales)) %>% arrange(store_code_uc, desc(sum_sales))

upc_rankings <- data.frame()

problem_stores <- unique(problem_child$store_code_uc)

for(i in seq_along(problem_stores)) {
  agg_store <- agg %>% filter(store_code_uc==problem_stores[i]) %>% mutate(rank=dense_rank(desc(sum_sales)))
  total_rank <- max(agg_store$rank)
  agg_upc <- agg_store %>% filter(upc=="007010001590") 
  agg_upc$total=total_rank
  upc_rankings <- upc_rankings %>% bind_rows(agg_upc)
}

rm(agg_store, total_rank, agg_upc, problem_child, agg, count)
```

Drop UPCs with multiple manufacturers for Novelties (see below for why)
```{r}
novel_slim <- nd_novel %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

drops_1 <- novel_slim %>% filter(upc=="004100013675" & store_code_uc %in% c(187110, 790659, 791868, 4471593, 7326857, 7329996, 8135076))

drops_2 <- novel_slim %>% filter(upc=="007054701498" & store_code_uc %in% c(187110, 7329678, 7570754))

drops_3 <- novel_slim %>% filter(upc=="007756700489" & store_code_uc %in% c(187110, 7329678, 7570754))

drops <- drops_1 %>% bind_rows(drops_2) %>% bind_rows(drops_3)

chr <- c("store_code_uc", "upc")

novel_slim <- anti_join(x=novel_slim, y=drops, by=chr)

rm(drops, drops_1, drops_2, drops_3)
```

Novelties
```{r}
stores <- unique(novel_slim$store_code_uc)

full_weeks <- novel_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- novel_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- novel_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    novel_slim <- novel_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_novel)
```

```{r, eval=FALSE}
count <- nd_novel %>% distinct(upc, manuf_name) %>% group_by(upc) %>% summarise(n_manuf=n())

count %>% filter(n_manuf>1) #upcs with more than 1 manufacturer

problem_child <- novel_slim %>% filter(upc %in% c("004100013675", "007054701498", "007756700489"))

problem_child <- problem_child %>% arrange(store_code_uc, upc)

agg <- novel_slim %>% group_by(store_code_uc, upc) %>% summarise(sum_sales=sum(sales)) %>% arrange(store_code_uc, desc(sum_sales))

upc_rankings <- data.frame()

problem_stores <- unique(problem_child$store_code_uc)

for(i in seq_along(problem_stores)) {
  agg_store <- agg %>% filter(store_code_uc==problem_stores[i]) %>% mutate(rank=dense_rank(desc(sum_sales)))
  total_rank <- max(agg_store$rank)
  agg_upc <- agg_store %>% filter(upc %in% c("004100013675", "007054701498", "007756700489")) 
  agg_upc$total=total_rank
  upc_rankings <- upc_rankings %>% bind_rows(agg_upc)
}

rm(agg_store, total_rank, agg_upc, problem_child, agg, count)
```

Peanut butter
```{r}
pb_slim <- nd_pb %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(pb_slim$store_code_uc)

full_weeks <- pb_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- pb_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- pb_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    pb_slim <- pb_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_pb)
```

Pickles and Olives
```{r}
pickles_slim <- nd_pick %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

stores <- unique(pickles_slim$store_code_uc)

full_weeks <- pickles_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- pickles_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- pickles_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    pickles_slim <- pickles_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_pick)
```

Frozen Dinners
```{r}
froz_din_slim <- nd_frozen %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")

drops <- froz_din_slim %>% filter(upc=="003666906148" & store_code_uc %in% c(187110, 4471593, 7329678, 7570754))

chr <- c("store_code_uc", "upc")

froz_din_slim <- anti_join(x=froz_din_slim, y=drops, by=chr)

rm(drops)
```

```{r}
stores <- unique(froz_din_slim$store_code_uc)

full_weeks <- froz_din_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- froz_din_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- froz_din_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    froz_din_slim <- froz_din_slim %>% bind_rows(missing_weeks)
    
  }
}

rm(stores, full_weeks, partial_upc, single_upc, manufacturer, missing_weeks, nd_frozen)
```

```{r, eval=FALSE}
count <- nd_frozen %>% distinct(upc, manuf_name) %>% group_by(upc) %>% summarise(n_manuf=n())

count %>% filter(n_manuf>1) #upcs with more than 1 manufacturer

problem_child <- froz_din_slim %>% filter(upc=="003666906148")

problem_child <- problem_child %>% arrange(store_code_uc, upc)

agg <- froz_din_slim %>% group_by(store_code_uc, upc) %>% summarise(sum_sales=sum(sales)) %>% arrange(store_code_uc, desc(sum_sales))

upc_rankings <- data.frame()

problem_stores <- unique(problem_child$store_code_uc)

for(i in seq_along(problem_stores)) {
  agg_store <- agg %>% filter(store_code_uc==problem_stores[i]) %>% mutate(rank=dense_rank(desc(sum_sales)))
  total_rank <- max(agg_store$rank)
  agg_upc <- agg_store %>% filter(upc=="003666906148") 
  agg_upc$total=total_rank
  upc_rankings <- upc_rankings %>% bind_rows(agg_upc)
}

rm(agg_store, total_rank, agg_upc, problem_child, agg, count)
```

Leftjoin the retailer code with the slim data. 
```{r}
cereal_slim <- cereal_slim %>% left_join(r_cereal, by="store_code_uc")
froz_din_slim <- froz_din_slim %>% left_join(r_frozen, by="store_code_uc")
icecream_slim <- icecream_slim %>% left_join(r_icecream, by="store_code_uc")
lmeat_slim <- lmeat_slim %>% left_join(r_lmeat, by="store_code_uc")
novel_slim <- novel_slim %>% left_join(r_novel, by="store_code_uc")
pb_slim <- pb_slim %>% left_join(r_pb, by="store_code_uc")
pickles_slim <- pickles_slim %>% left_join(r_pickles, by="store_code_uc")
sj_slim <- sj_slim %>% left_join(r_sj, by="store_code_uc")
soup_slim <- soup_slim %>% left_join(r_soup, by="store_code_uc")

rm(r_cereal, r_frozen, r_icecream, r_lmeat, r_novel, r_pb, r_pickles, r_sj, r_soup)
```

Create a `treat` variable that is 1 for treated stores and 0 for control stores (treated retailer is 903). 
```{r}
cereal_slim <- cereal_slim %>% mutate(treat=if_else(retailer_code==903 & week_end>2012-01-01, 1, 0))
```






