---
title: "North Dakota Diff in diff model using synthetic control from Microsynth"
output: github_document
---

Load libraries and data for each category in ND. 
```{r}
library(tidyverse)
library(microsynth)

load(here::here("..", "nd_cereal_clean.RData"))
nd_cereal <- nd_data

load(here::here("..", "nd_spreads_jams_clean.RData"))
nd_sj <- nd_data 

load(here::here("..", "nd_can_soup_clean.RData"))
nd_soup <- nd_data

load(here::here("..", "nd_ice_cream_clean.RData"))
nd_ice_cream <- nd_data

load(here::here("..", "nd_lunchmeat_clean.RData"))
nd_lmeat <- nd_data

load(here::here("..", "nd_novel_clean.RData"))
nd_novel <- nd_data

load(here::here("..", "nd_pb_clean.RData"))
nd_pb <- nd_data

load(here::here("..", "nd_pickles_olives_clean.RData"))
nd_pick <- nd_data

load(here::here("..", "nd_frozen_dinners_clean.RData"))
nd_frozen <- nd_data 

rm(nd_data)
```

Create a smaller data set with only the variables we are interested in, and filter for observations only after 2010. 
```{r}
cereal_slim <- nd_cereal %>% select(store_code_uc, week_end, upc, sales, manuf_name) %>% filter(week_end > "2010-12-31")
```

Create a `stores` vector that contains the unique store codes in the `cereal_slim` dataset. Create `full_weeks` which is a list of the 157 `week_end`s from 2011-2013. Write a loop that goes along each store and upc adding in zero sales values for upcs with missing dates. Bind those missing upc dates and sales back into the main data `cereal_slim`. 
```{r}
stores <- unique(cereal_slim$store_code_uc)

full_weeks <- cereal_slim %>% distinct(week_end) 

for(i in seq_along(stores)) {
  
  partial_upc <- cereal_slim %>% filter(store_code_uc==stores[i]) %>% distinct(upc, week_end) %>% group_by(upc) %>%
  summarise(n_weeks=n()) %>% filter(n_weeks <157) %>% select(upc) %>% pull()
  
  for(j in seq_along(partial_upc)) {
    
    single_upc <- cereal_slim %>% filter(store_code_uc==stores[i], upc==partial_upc[j])
    
    manufacturer <- unique(single_upc$manuf_name)

    missing_weeks <- full_weeks %>% anti_join(single_upc, by="week_end") %>% mutate(sales=0, store_code_uc=stores[i],
      upc=partial_upc[j], manuf_name=manufacturer)

    cereal_slim <- cereal_slim %>% bind_rows(missing_weeks)
    
  }
}
```








